{% extends "base.html" %}

{% block content %}
<div class="container my-4">
  <h2 class="mb-4 text-center">
    <i class="fas fa-bullseye me-2"></i>Financial Goals
  </h2>

  <!-- Goal Progress Overview -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card metrics-card">
        <div class="card-body text-center">
          <div class="metric-label">Goal Amount</div>
          <div class="metric-value text-warning">
            {{ format_currency(goal.goal_amount) }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card metrics-card">
        <div class="card-body text-center">
          <div class="metric-label">Current Value</div>
          <div class="metric-value text-primary">
            {{ format_currency(goal.current_value) }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card metrics-card">
        <div class="card-body text-center">
          <div class="metric-label">Progress</div>
          <div class="metric-value {% if goal.current_value >= goal.goal_amount %}text-success{% else %}text-info{% endif %}">
            {{ format_percentage((goal.current_value / goal.goal_amount) * 100) }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card metrics-card">
        <div class="card-body text-center">
          <div class="metric-label">Time Remaining</div>
          <div class="metric-value">
            {{ "%.1f"|format(goal.years_to_goal) }} years
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Goal Details Card -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-target me-2"></i>Goal Details
      </h5>

      <!-- Progress Bar -->
      <div class="mb-4">
        <div class="d-flex justify-content-between mb-2">
          <span>Progress to Goal</span>
          <span>{{ format_percentage((goal.current_value / goal.goal_amount) * 100) }}</span>
        </div>
        {% set progress_percent = (goal.current_value / goal.goal_amount * 100) %}
        {% if progress_percent > 100 %}
        {% set progress_percent = 100 %}
        {% endif %}
        <div class="progress" style="height: 25px;">
          <div class="progress-bar {% if goal.current_value >= goal.goal_amount %}bg-success{% elif goal.on_track %}bg-info{% else %}bg-warning{% endif %}"
               role="progressbar"
               style="width: {{ progress_percent }}%"
               aria-valuenow="{{ goal.current_value }}"
               aria-valuemin="0"
               aria-valuemax="{{ goal.goal_amount }}">
            {{ format_currency(goal.current_value) }}
          </div>
        </div>
      </div>

      <!-- Goal Status -->
      <div class="row">
        <div class="col-md-6">
          <h6 class="mb-3">Current Status</h6>
          <dl class="row">
            <dt class="col-sm-6">Monthly Contribution</dt>
            <dd class="col-sm-6">{{ format_currency(goal.current_monthly_contribution) }}</dd>

            <dt class="col-sm-6">Savings Needed</dt>
            <dd class="col-sm-6">{{ format_currency(goal.monthly_savings_needed) }}</dd>

            <dt class="col-sm-6">Savings Gap</dt>
            <dd class="col-sm-6" class="{% if goal.savings_gap > 0 %}text-danger{% else %}text-success{% endif %}">
              {{ format_currency(abs(goal.savings_gap)) }}
              {% if goal.savings_gap <= 0 %}
              <small class="text-success">(Surplus)</small>
              {% else %}
              <small class="text-danger">(Deficit)</small>
              {% endif %}
            </dd>

            <dt class="col-sm-6">Success Probability</dt>
            <dd class="col-sm-6">
                            <span class="{% if goal.probability_of_success > 0.8 %}text-success{% elif goal.probability_of_success > 0.6 %}text-warning{% else %}text-danger{% endif %}">
                                {{ format_percentage(goal.probability_of_success * 100) }}
                            </span>
            </dd>
          </dl>
        </div>

        <div class="col-md-6">
          <h6 class="mb-3">Goal Tracking</h6>
          <div class="alert {% if goal.on_track %}alert-success{% else %}alert-warning{% endif %}">
            <i class="fas fa-{% if goal.on_track %}check-circle{% else %}exclamation-triangle{% endif %} me-2"></i>
            {% if goal.on_track %}
            <strong>On Track!</strong> Your current savings rate is sufficient to reach your goal.
            {% else %}
            <strong>Action Required!</strong> You need to save an additional ₹{{ "{:,.0f}".format(goal.savings_gap) }} per month.
            {% endif %}
          </div>

          {% if goal.years_to_goal <= 0 %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Goal Date Reached!</strong>
            {% if goal.current_value >= goal.goal_amount %}
            Congratulations! You've achieved your goal.
            {% else %}
            You're ₹{{ "{:,.0f}".format(goal.goal_amount - goal.current_value) }} short of your goal.
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Goal Calculator -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-calculator me-2"></i>Goal Calculator
      </h5>
      <form method="GET" action="{{ url_for('goals') }}" class="needs-validation">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-semibold">Goal Amount (₹)</label>
            <input type="number" name="goal_amount" class="form-control"
                   value="{{ goal_amount }}" min="100000" step="100000" required>
            <small class="text-muted">Target amount you want to achieve</small>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Time Frame (Years)</label>
            <input type="number" name="goal_years" class="form-control"
                   value="{{ goal_years }}" min="1" max="40" step="1" required>
            <small class="text-muted">Years to achieve your goal</small>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-semibold">Monthly Contribution (₹)</label>
            <input type="number" name="monthly_contribution" class="form-control"
                   value="{{ monthly_contribution }}" min="0" step="1000" required>
            <small class="text-muted">Amount you can save monthly</small>
          </div>
        </div>
        <div class="mt-3">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-calculator me-2"></i>Calculate Goal Progress
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Savings Scenarios -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-chart-line me-2"></i>What-If Scenarios
      </h5>
      <p class="text-muted">See how different monthly savings affect your goal achievement</p>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
          <tr>
            <th>Monthly Savings</th>
            <th>Total Contribution</th>
            <th>Expected Final Value</th>
            <th>Goal Achievement</th>
            <th>Status</th>
          </tr>
          </thead>
          <tbody>
          {% set savings_scenarios = [
          goal.monthly_savings_needed * 0.5,
          goal.monthly_savings_needed * 0.75,
          goal.monthly_savings_needed,
          goal.monthly_savings_needed * 1.25,
          goal.monthly_savings_needed * 1.5
          ] %}
          {% for savings in savings_scenarios %}
          {% set total_contributions = savings * 12 * goal.years_to_goal %}
          {% set future_value = goal.current_value * (1.12 ** goal.years_to_goal) +
          (savings * 12 * ((1.12 ** goal.years_to_goal - 1) / 0.12)) %}
          {% set achievement_percent = (future_value / goal.goal_amount * 100) %}
          {% if achievement_percent > 100 %}
          {% set achievement_percent = 100 %}
          {% endif %}
          <tr {% if savings == goal.monthly_savings_needed %}class="table-info"{% endif %}>
            <td>{{ format_currency(savings) }}</td>
            <td>{{ format_currency(total_contributions) }}</td>
            <td>{{ format_currency(future_value) }}</td>
            <td>
              <div class="progress" style="min-width: 100px;">
                <div class="progress-bar {% if future_value >= goal.goal_amount %}bg-success{% else %}bg-warning{% endif %}"
                     style="width: {{ achievement_percent }}%">
                  {{ format_percentage(achievement_percent) }}
                </div>
              </div>
            </td>
            <td>
              {% if future_value >= goal.goal_amount %}
              <span class="badge bg-success">Goal Achieved</span>
              {% else %}
              <span class="badge bg-warning">₹{{ "{:,.0f}".format(goal.goal_amount - future_value) }} short</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tips for Goal Achievement -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-lightbulb me-2"></i>Tips to Achieve Your Goal
      </h5>
      <div class="row">
        <div class="col-md-6">
          <h6>Increase Savings</h6>
          <ul>
            <li>Automate monthly transfers to investment account</li>
            <li>Increase contribution with salary hikes</li>
            <li>Invest bonuses and windfalls</li>
            <li>Cut unnecessary expenses</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6>Optimize Returns</h6>
          <ul>
            <li>Review and rebalance portfolio regularly</li>
            <li>Consider tax-efficient investments</li>
            <li>Avoid emotional investing decisions</li>
            <li>Stay invested for the long term</li>
          </ul>
        </div>
      </div>

      {% if not goal.on_track %}
      <div class="alert alert-warning mt-3">
        <h6 class="alert-heading">
          <i class="fas fa-exclamation-triangle me-2"></i>Recommendations
        </h6>
        <p class="mb-0">
          To get back on track, consider:
        <ul class="mb-0">
          <li>Increasing monthly savings by ₹{{ "{:,.0f}".format(goal.savings_gap) }}</li>
          <li>Extending your goal timeline by {{ "%.1f"|format(goal.savings_gap / goal.current_monthly_contribution / 12) }} years</li>
          <li>Finding additional income sources</li>
          <li>Reviewing your investment strategy for better returns</li>
        </ul>
        </p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="text-center">
    <a href="{{ url_for('projections') }}" class="btn btn-primary me-2">
      <i class="fas fa-chart-line me-2"></i>View Projections
    </a>
    <a href="{{ url_for('fire_calculator') }}" class="btn btn-success me-2">
      <i class="fas fa-fire me-2"></i>FIRE Calculator
    </a>
    <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">
      <i class="fas fa-home me-2"></i>Dashboard
    </a>
  </div>
</div>

<style>
  .metrics-card {
    transition: all 0.3s ease;
  }

  .metrics-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }

  .progress {
    background-color: #e9ecef;
  }

  .badge {
    font-size: 0.875rem;
    padding: 0.375rem 0.75rem;
  }

  .table th {
    font-weight: 600;
    color: #495057;
  }
</style>
{% endblock %}